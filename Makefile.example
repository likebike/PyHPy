# This is the MakoFW Project Makefile.
# Adjust this Makefile to suit your server and project requirements.

# Find the location of this Makefile:
THIS_MAKEFILE=$(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))
MAKEFILE_DIR=$(patsubst %/,%,$(dir $(THIS_MAKEFILE)))

# We use the Makefile location to guess our project root:
PROJ_ROOT=${MAKEFILE_DIR}

# The MakoFW location:
MAKOFW_DIR=${PROJ_ROOT}/makofw

# The 'input' and 'build' directories:
IN_DIR=${PROJ_ROOT}/input
BUILD_DIR=${PROJ_ROOT}/build

# The publication locations:
OUT_DEV=${PROJ_ROOT}/output/dev
OUT_PROD=${PROJ_ROOT}/output/prod

# The python binary to use:
PYTHON=python2.7
export PYTHONPATH:=${MAKOFW_DIR}/lib/python:${PYTHONPATH}


# By default, publish to the development site:
dev: inputToBuild
	MAKOFW_BUILD_MODE=dev ${PYTHON} ${MAKOFW_DIR}/bin/publish.py "${BUILD_DIR}" "${OUT_DEV}"

# Publish to the development site without doing as many ACL checks:
fast: inputToBuild
	MAKOFW_BUILD_MODE=dev ACL_CHECK=0 ${PYTHON} ${MAKOFW_DIR}/bin/publish.py "${BUILD_DIR}" "${OUT_DEV}"

# Publish to the production site:
prod: inputToBuild
	MAKOFW_BUILD_MODE=prod ${PYTHON} ${MAKOFW_DIR}/bin/publish.py "${BUILD_DIR}" "${OUT_PROD}"

# Copy 'input' to 'build':
inputToBuild:
	rsync -va ${IN_DIR}/ ${BUILD_DIR}

# Touch some critical files that force the whole site to be rebuilt:
touch:
	touch ${IN_DIR}/__init__.tmpl

# Remove the 'build' area:
clean: touch
	rm -rf ${BUILD_DIR}


# Automatically remove unexpected files from the output:
# The first line is a target-specific variable (http://www.gnu.org/software/make/manual/html_node/Target_002dspecific.html).
autorm: export AUTO_RM = 1
autorm: dev
# ...And the same thing for prod:
autorm-prod: export AUTO_RM = 1
autorm-prod: prod


# Useful for local development and testing:
devserver:
	cd "${OUT_DEV}"; ${PYTHON} -m SimpleHTTPServer 8000



